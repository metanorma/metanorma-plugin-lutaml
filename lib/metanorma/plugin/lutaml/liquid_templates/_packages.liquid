{% for package in context.packages %}
{% assign package_name = package.name | downcase | replace: ":", "" | replace: " ", "_" %}
{% if additional_context.before %}
{{ additional_context.before.text }}
{% endif %}
{% assign before_package_key = 'before;' | append: package.name %}
{% if additional_context[before_package_key] %}
{{ additional_context[before_package_key].text }}
{% endif %}
{% assign is_package_spare = package.name | slice: 0,5 %}
{% if is_package_spare == 'old: ' %}{% continue %}
{% elsif is_package_spare == 'Spare' %}{% continue %}
{% endif %}

{% capture equalsigns %}{% for count in (1..depth) %}={% endfor %}{% endcapture %}{{equalsigns}} {{ package.name }} package
{{equalsigns}}= {{ package.name }} overview

{% if additional_context.diagram_include_block %}
{% include "diagrams_block", package_name: package_name, image_base_path: additional_context.diagram_include_block.base_path, text: additional_context.diagram_include_block.text %}
{% endif %}

{% if package.packages.size > 0 %}The {{ package.name }} package is organized into
{{ package.packages.size }} packages{% assign modules_nested_size = 0 %}{% for module in package.packages %}{% assign modules_nested_size = modules_nested_size | plus: module.packages.size %}{% endfor %}{% if modules_nested_size > 0 %} with {{modules_nested_size}} modules{% endif %}:
{% endif %}
[arabic]
{% for module in package.packages %}
{% if module.packages.length > 0 %}
. {{ module.name }} package comprises:
{% for nested_module in module.packages %}
.. {{nested_module.name}} module
{% endfor %}
{% else %}
. {{ module.name }} package
{% endif %}
{% endfor %}

{% if package.classes.size > 0 or package.enums.size > 0 or package.data_types.size > 0 %}

{{equalsigns}}= Defining tables

[arabic]
{% for klass in package.classes %}
{% assign is_klass_spare = klass.name | slice: 0,5 %}
{% if is_klass_spare == 'old: ' %}{% continue %}
{% elsif is_klass_spare == 'Spare' %}{% continue %}
{% endif %}
{% assign klass_name = klass.name | downcase | replace: ':', '' | replace: ' ', '_' %}
.<<tab-P-{{ package_name }}-C-{{ klass_name }}>> -- Elements of {{ package.name }}::{{ klass.name }}

{% endfor %}
{% for enum in package.enums %}
{% assign is_enum_spare = enum.name | slice: 0,5 %}
{% if is_enum_spare == 'old: ' %}{% continue %}
{% elsif is_enum_spare == 'Spare' %}{% continue %}
{% endif %}
{% assign enum_name = enum.name | downcase | replace: ':', '' | replace: ' ', '_' %}
.<<tab-P-{{ package_name }}-E-{{ enum_name }}>> -- Elements of {{ package.name }}::{{ enum.name }}

{% endfor %}
{% for data_type in package.data_types %}
{% assign is_data_type_spare = data_type.name | slice: 0,5 %}
{% if is_data_type_spare == 'old: ' %}{% continue %}
{% elsif is_data_type_spare == 'Spare' %}{% continue %}
{% endif %}
{% assign data_type_name = data_type.name | downcase | replace: ':', '' | replace: ' ', '_' %}
.<<tab-P-{{ package_name }}-DT-{{ data_type_name }}>> -- Elements of {{ package.name }}::{{ data_type.name }}

{% endfor %}

{% for klass in package.classes %}
{% include "packages_class" %}
{% endfor %}

{% for klass in package.enums %}
{% include "packages_enum" %}
{% endfor %}

{% for klass in package.data_types %}
{% include "packages_data_type" %}
{% endfor %}

{% endif %}

{% if additional_context.include_block %}
{% assign block = additional_context.include_block %}
{% capture block_filename %}{{ block.base_path }}/{{ package_name }}{% endcapture %}
{{ block_filename }}
{% capture block_content %}{% include block_filename %}{% endcapture %}
{% unless block_content contains "Liquid error" %}
{% if block.text %}
{{ block.text }}
{% endif %}
{{ block_content }}
{% endunless %}
{% endif %}

{% assign include_block_package_key = 'include_block;' | append: package.name %}
{% assign block = additional_context[include_block_package_key] %}
{% if block %}
{% capture block_filename %}{{ block.base_path }}/{{ package_name }}{% endcapture %}
{{ block_filename }}
{% capture block_content %}{% include block_filename %}{% endcapture %}
{% unless block_content contains "Liquid error" %}
{% if block.text %}
{{ block.text }}
{% endif %}
{{ block_content }}
{% endunless %}
{% endif %}

{% assign after_package_key = 'after;' | append: package.name %}
{{equalsigns}}= Additional Information
{% if additional_context[after_package_key] %}
{{ additional_context[after_package_key].text }}
{% endif %}
{% if render_nested_packages %}
This is render_nested_packages
{% endif %}
{% if package.packages.size > 0 and render_nested_packages %}{% assign nested_depth = depth | plus: 1 %}{% include "packages", depth: nested_depth, context: package %}{% endif %}
{% endfor %}

{% if additional_context.after %}
{{ additional_context.after.text }}
{% endif %}